---
title: "Vizgen Liver"
author: "M. Muzamil Khan"
date: "4/6/2022"
output: html_document
---

Vizgen MERFISH Liver - Rep 1, Slice 1

This vignette presents a standard processing workflow to perform data analyses generated by [MERFISH](https://vizgen.com/technology/#merfish) technology. This dataset is for slice 1 from a mouse liver consisting of >395K cells with a panel of 385 genes.

```{r setup, include=FALSE}
library(knitr)
knitr::opts_chunk$set(echo = TRUE, cache = TRUE, warning = FALSE, 
                      message = FALSE, cache.lazy = FALSE)
path_to_dir <- '/Volumes/GoogleDrive/Shared drives/Dries_lab/Datasets/VizgenLiverShowcase/Liver1Slice1/'
temp_dir = '~/Documents/Research/spatial/vizgen_liver/vizgen_mouse_liver/'
tx_path <- "~/Documents/Research/spatial/vizgen_liver/tx_selected.csv"
```

```{r, eval=F}
library(Giotto)
library(data.table)
library(ggplot2)
library(rhdf5)
```

# Read in the expression and spatial data

```{r, eval=F}

myinstructions = createGiottoInstructions(save_dir  = temp_dir,
                                          save_plot = TRUE, 
                                          show_plot = FALSE
                                        )

# create giotto object
expr_path = paste0(path_to_dir, 'cell_by_gene.csv')
expr_matrix = readExprMatrix(expr_path)
expr_matrix[1:4, 1:4]
dim(expr_matrix)

spat_path = paste0(path_to_dir, 'cell_metadata.csv')
spat_dt = fread(spat_path)
spat_dt$cell_id_orig <- spat_dt$V1
#arrange the cell_IDs according to the expression matrix
spat_dt <- spat_dt[match(rownames(expr_matrix), cell_id_orig)]
head(spat_dt)
```


# Create giotto object

```{r, eval=F}
vizgen_liver <- createGiottoObject(raw_exprs = Giotto:::t_flex(expr_matrix),
                                   spatial_locs = spat_dt[,.(center_x, center_y, V1)],
                                   instructions = myinstructions, verbose = F)

vizgen_liver <- addCellMetadata(vizgen_liver, new_metadata = spat_dt[,.(fov, volume)])
```

```{r, eval=F}
spatPlot2D(gobject = vizgen_liver, 
          background_color = "white", 
           show_plot = T, return_plot = F, save_plot = T, save_param = list(show_saved_plot = FALSE, dpi=300,  save_format = "png"),
           point_size = 0.2, legend_symbol_size = 6, label_size = 6, default_save_name = "vizgen_liver_spatplot_full")
```
![](../inst/images/vizgen_mouse_liver/0-vizgen_liver_spatplot_full.png){ width=50% }

# Normalization and filtering

```{r, eval=F}
#process giotto object
vizgen_liver <- Giotto::filterGiotto(gobject = vizgen_liver,
                             expression_threshold = 1,
                             feat_det_in_min_cells = 100,
                             min_det_feats_per_cell = 20, 
                             verbose = F)

vizgen_liver <- Giotto::normalizeGiotto(gobject = vizgen_liver, scalefactor = 1000, verbose = T)

vizgen_liver <- Giotto::addStatistics(gobject = vizgen_liver)

```

# Dimensionality reduction
Perform PCA and UMAP for further downstream analyses.
PCA
```{r, eval=F}
#dimension reduction
vizgen_liver <- runPCA(gobject = vizgen_liver, 
                       center = TRUE, 
                       scale_unit = TRUE)
screePlot(vizgen_liver, ncp = 30)

```
[](../inst/images/vizgen_mouse_liver/1-screePlot.png){ width=50% }


```{r, eval=F}
Giotto::plotPCA(gobject = vizgen_liver,
                point_size = 0.5,
                show_plot = F,
                return_plot = F, 
                save_plot = T, 
                save_param = list(show_saved_plot = TRUE))

```

[](../inst/images/vizgen_mouse_liver/2-PCA.png){ width=50% }

UMAP
```{r, eval=F}
vizgen_liver = runUMAP(vizgen_liver,
                       dimensions_to_use = 1:10)

plotUMAP(gobject = vizgen_liver, 
         point_size = 0.5,
         show_plot = T, 
         return_plot = F, 
         save_plot = T)
```
[](../inst/images/vizgen_mouse_liver/3-UMAP.png){ width=50% }

# Clustering

Perform Leiden clustering
```{r, eval=F}
##Leiden clustering
vizgen_liver <- createNearestNetwork(vizgen_liver,
                                     dimensions_to_use = 1:10,
                                     k =15)

vizgen_liver <- doLeidenCluster(gobject = vizgen_liver, 
                                resolution = 0.2, 
                                n_iterations = 1000, 
                                name="leiden0.2")

cell_metadata = pDataDT(vizgen_liver)
leiden_names = unique(cell_metadata$leiden0.2)
leiden_colors = Giotto::getDistinctColors(n = length(leiden_names))
names(leiden_colors) = rev(leiden_names)
```

```{r, eval=F}
plotUMAP(vizgen_liver,
         cell_color = 'leiden0.2', 
         cell_color_code = leiden_colors,
         point_size = 0.25, 
         show_plot = T, 
         return_plot = F, 
         save_plot = T, 
         label_size = 6, 
         save_param = list(save_format = "png", dpi=300))
```
[](../inst/images/vizgen_mouse_liver/4-UMAP.png){ width=50% }

Visualize leiden clusters spatially

```{r, eval=F}
spatPlot2D(vizgen_liver, cell_color = 'leiden0.2', cell_color_code = leiden_colors,
           show_plot = T, return_plot = F, save_plot = T, 
           save_param = list(show_saved_plot = FALSE, dpi=300,  save_format = "png", base_width = 7, base_height = 8),
           point_size = 0.4, point_alpha = 1, legend_symbol_size = 6, label_size = 6, background_color = "black", coord_fix_ratio = TRUE)
```
[](../inst/images/vizgen_mouse_liver/10-spatPlot2D.png){ width=50% }

# Spatial Expression Patterns

To get the highly specific genes spatially.

```{r, eval=F}
# create spatial network based on physical distance of cell centroids
vizgen_liver = createSpatialNetwork(gobject = vizgen_liver, minimum_k = 2,
                              maximum_distance_delaunay = 50)

# select features
feats = vizgen_liver@feat_ID$rna
# perform Binary Spatial Extraction of genes
km_spatialgenes = binSpect(vizgen_liver, subset_feats = feats)

```

```{r, eval=F}
# visualize spatial expression of selected genes obtained from binSpect
spatFeatPlot2D(vizgen_liver, expression_values = 'scaled',
               feats = c("Cyp2c38", 'Hsd17b6', "Egfr"),
               cell_color_gradient = c('blue', 'white', 'red'),
               point_shape = 'border', point_border_stroke = 0.01,
               show_network = F, network_color = 'lightgrey', 
               point_size = 0.2,
               cow_n_col = 2)
```
[](../inst/images/vizgen_mouse_liver/5-spatFeatPlot2D.png){ width=50% }

# Subset giotto 

for zoom-in subsections to identify certain niches

```{r, eval=F}
#subset giotto obj
vizgen_liver_subset <- subsetGiottoLocs(gobject = vizgen_liver,
                                  x_min = 4800, 
                                  x_max = 7000,
                                  y_min = 6900,
                                  y_max = 9000)

```

```{r, eval=F}
spatDimPlot(vizgen_liver_subset, 
                  dim_reduction_to_use = "umap", 
                  cell_color = 'leiden0.2', 
                  show_plot = T, return_plot = F, 
                  save_plot = T, dim_point_size = 1, 
                  legend_symbol_size = 6,
                  save_param = list(show_saved_plot = FALSE, dpi=300,  save_format = "png", base_width = 7, base_height = 8)
                  )
```
[](../inst/images/vizgen_mouse_liver/6-spatDimPlot2D.png){ width=50% }

# Create subsection for further downstream analyses

Create a small section to identify subcellular boundaries and gene transcripts detected in each cell.

```{r, eval=F}
vizgen_liver_subset1 <- subsetGiottoLocs(gobject = vizgen_liver,
                                  x_min = 5400, 
                                  x_max = 5750,
                                  y_min = 8500,
                                  y_max = 8650)

```

```{r, eval=F}
spatDimPlot(vizgen_liver_subset1, 
                  dim_reduction_to_use = "umap", 
                  cell_color = 'leiden0.2', 
                  show_plot = T, return_plot = F, 
                  save_plot = T, dim_point_size = 1,spat_point_size=2,
                  legend_symbol_size = 6,
                  save_param = list(show_saved_plot = FALSE, dpi=300,  save_format = "png", base_width = 7, base_height = 8)
                  )
```
[](../inst/images/vizgen_mouse_liver/8-spatDimPlot2D.png){ width=50% }

# Subcellular Cell boundaries
Add polygon information for cells and trx coordinates.
The final plot shows selected genes that are specific in liver niches/subunits.

```{r, eval=F}
library(rhdf5)

subset_metadata = pDataDT(vizgen_liver_subset1)
#choose 2 fovs for now
selected_fovs = unique(subset_metadata$fov)

hdf5_boundary_list = list.files(full.names = T, paste0(path_to_dir, 'cell_boundaries'))

selected_hdf5s = paste0('feature_data_', selected_fovs,'.hdf5')
hdf5_boundary_selected_list = list()
for(hdf5_i in 1:length(selected_hdf5s)) {
  hdf5 = selected_hdf5s[hdf5_i]
  hdf5_boundary_selected = grep(pattern = hdf5, x = hdf5_boundary_list, value = T)[[1]]
  hdf5_boundary_selected_list[[hdf5_i]] = hdf5_boundary_selected
}

final_list = list()
result_list = list()
start_index = 1

for(bound_i in 1:length(hdf5_boundary_selected_list)) {
  
  print(bound_i)
  
  test = rhdf5::H5Fopen(hdf5_boundary_selected_list[bound_i][[1]])
  featdt = test$featuredata
  
  cell_names = names(featdt)
  
  for(cell_i in 1:length(featdt)) {
    singlearray = featdt[[cell_i]]$zIndex_0$p_0$coordinates
    
    cell_name = cell_names[[cell_i]]
    
    if(!is.null(singlearray)) {
      singlearraydt = data.table::as.data.table(t(as.matrix(singlearray[,,1])))
      singlearraydt[, file_id := paste0('file', bound_i)]
      singlearraydt[, cell_id := cell_name]
      singlearraydt[, my_id := paste0('cell',start_index)]
      result_list[[start_index]] = singlearraydt
    }
    
    start_index = start_index + 1
    
  }
  
  multidt = do.call('rbind', result_list)
  
}

# create giotto polygons
cell_polygons = createGiottoPolygonsFromDfr(segmdfr = multidt[,.(V1, V2, cell_id)])

# smooth to make them smaller
smooth_cell_polygons = smoothGiottoPolygons(cell_polygons, vertices = 20)

# add cell polygons to giotto object
vizgen_liver_subset1 = addGiottoPolygons(gobject = vizgen_liver_subset1, 
                                  gpolygons = list(smooth_cell_polygons))
vizgen_liver_subset1 <- addSpatialCentroidLocations(vizgen_liver_subset1,
                                      poly_info = 'cell')

# add transcript coordinates
tx_dt = fread(tx_path)
tx_dt_selected = tx_dt[fov %in% selected_fovs]

gpoints = createGiottoPoints(x = tx_dt_selected[,.(global_x,global_y, gene)])

vizgen_liver_subset1 = addGiottoPoints(gobject = vizgen_liver_subset1, 
                                gpoints = list(gpoints))


vizgen_liver_subset1 <- calculateOverlapRaster(vizgen_liver_subset1, 
                                               spatial_info = 'cell', 
                                               poly_ID_names = vizgen_liver_subset1@spatial_info$cell@spatVector$poly_ID)
vizgen_liver_subset1 = overlapToMatrix(vizgen_liver_subset1)

```

```{r, eval=F}
spatInSituPlotPoints(vizgen_liver_subset1,
                     feats = list('rna' = c("Cyp2c38", "Epcam", "Hsd17b6", "Akr1d1")),
                     point_size = 0.40, 
                     polygon_line_size = 0.25,
                     show_polygon = TRUE, 
                     polygon_feat_type = 'cell',
                     polygon_color = 'white',
                     return_plot = FALSE, 
                     save_plot = TRUE, 
                     show_plot = FALSE, 
                     save_param = list(show_saved_plot = TRUE))
```
![](../inst/images/vizgen_mouse_liver/9-spatInSituPlotPoints.png){ width=50% }

